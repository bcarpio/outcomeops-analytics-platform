name: OutcomeOps Analytics Platform CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

  workflow_dispatch:

env:
  AWS_REGION: us-west-2

permissions:
  id-token: write
  contents: read

jobs:

  security-scans:
    name: Security Scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Talisman
        run: |
          curl -Lo talisman https://github.com/thoughtworks/talisman/releases/latest/download/talisman_linux_amd64
          chmod +x talisman
          sudo mv talisman /usr/local/bin/

      - name: Run Talisman Scan
        run: |
          talisman --githook pre-commit || true

      - name: Process Talisman Report
        run: |
          if [ ! -f talisman_report/talisman_reports/data/report.json ]; then
            echo "No high severity issues detected by Talisman."
            exit 0
          fi

          echo "Processing Talisman findings..."

          echo "Summary of Detected Types:" > talisman_violations.txt
          jq -r '.summary.types | to_entries[] | "\(.key): \(.value)"' talisman_report/talisman_reports/data/report.json >> talisman_violations.txt

          echo "" >> talisman_violations.txt
          echo "Detailed Failures:" >> talisman_violations.txt

          jq -r '.results[]
            | select(.failure_list != null)
            | . as $result
            | $result.failure_list[]
            | select(.severity == "high" or .severity == "critical")
            | "Filename: \($result.filename)\nSeverity: \(.severity)\nMessage: \(.message)\n"' talisman_report/talisman_reports/data/report.json >> talisman_violations.txt

          echo ""
          cat talisman_violations.txt

          if grep -q "Severity: high\|Severity: critical" talisman_violations.txt; then
            echo "High severity issues found in Talisman scan!"
            exit 1
          else
            echo "No high severity issues detected by Talisman."
          fi

      - name: Trivy - Scan Terraform
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: terraform
          severity: CRITICAL,HIGH
          exit-code: 1

  lambda-tests:
    name: Lambda Tests
    runs-on: ubuntu-latest
    needs: security-scans
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: make deps

      - name: Run unit tests
        run: make test-unit

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: lambda-tests
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: make deps

      - name: Run tests with coverage
        run: make test-ci

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.1.0
        with:
          args: >
            -Dsonar.projectKey=bcarpio_outcomeops-analytics-platform
            -Dsonar.organization=bcarpio
            -Dsonar.sources=lambda,ui/src
            -Dsonar.tests=lambda/analytics-api/tests,lambda/analytics-auth/tests,lambda/log-parser/tests
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.python.xunit.reportPath=junit.xml
            -Dsonar.exclusions=**/*_test.py,**/tests/**,**/__pycache__/**,**/.venv/**,**/node_modules/**,**/dist/**
            -Dsonar.test.inclusions=**/tests/**/*.py
            -Dsonar.host.url=https://sonarcloud.io
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: security-scans
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: make tf-init

      - name: Terraform Format Check
        run: make fmt-check

      - name: Terraform Validate
        run: make validate

  ui-build:
    name: UI Build & Lint
    runs-on: ubuntu-latest
    needs: security-scans
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: make ui-install

      - name: Type check
        run: make ui-typecheck

      - name: Lint
        run: make ui-lint

      - name: Build
        run: make ui-build-dev
